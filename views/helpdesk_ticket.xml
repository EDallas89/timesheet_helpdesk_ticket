<?xml version="1.0" encoding="utf-8" ?>
<data>
  <record id="timesheet_helpdesk_ticket_view_form" model="ir.ui.view">
    <field name="name">timesheet.helpdesk.ticket.form.view</field>
    <field name="model">helpdesk.ticket</field>
    <field name="inherit_id" ref="helpdesk_mgmt.ticket_view_form" />
    <field name="priority" eval="20" />
    <field name="arch" type="xml">
      <xpath expr="//field[@name='partner_email']" position="after">
        <field name="project" string="Proyecto"/>
        <field name="task" string="Tarea" domain="[('project_id', '=', project)]" attrs="{'invisible':[('project', '=', False)]}"/>
      </xpath>
      <xpath expr="//page[@name='attachment']" position="replace">
        <!-- Creamos la solapa para el Timesheet -->
        <page string="Timesheets">
          <!-- timesheet_ids es un campo con la vista embebida de account.analytic.line a través de un O2M-->
          <field name="timesheet_ids" context="{'default_project_id': project,'default_task_id': task}">
            <!-- Si no habilitamos la opción de editable="bottom" para crear un nuevo registro se crearía una ventana emergente-->
            <tree editable="bottom" delete="true">
              <!-- Estos campos pertenecen a la vista embebida y simplemente seleccionamos los que queremos utilizar-->
              <field name="project_id"/>
              <field name="task_id"/>
              <field name="date" widget="date" readonly="1" />
              <field name="user_id" readonly="1" />
              <field name="name"/>
              <!-- Creamos los campos que necesitamos para las fechas-->
              <field name="start_stop" invisible="1" />
              <!-- Start -->
              <button name="action_start" string="Start" type="object" icon="fa-play" attrs="{'invisible': ['|',('start_stop', '=', True),('date_stop', '!=', False)]}" />
              <field name="date_start" string="Hora de Inicio" readonly="1" />
              <!-- Pause -->
              <field name="date_reboot" invisible="1" />
              <button name="action_pause" string="Pause" type="object" icon="fa-pause" attrs="{'invisible': ['|',('start_stop', '=', False),('date_stop', '!=', False)]}" />
              <!-- Stop -->
              <button name="action_stop" string="Stop" type="object" icon="fa-stop" attrs="{'invisible': ['|',('date_start', '=', False), ('date_stop', '!=', False)]}" confirm="¿Seguro que quiere finalizar esta tarea?" />
              <field name="date_stop" string="Hora de Fin" readonly="1" />
              <!-- Recuento de Horas por Linea-->
              <field name="computed_hours" string="Horas Computadas" widget="float_time" readonly="1" />
              <field name="unit_amount" string="Horas Imputadas" widget="float_time"/>
            </tree>
            <form>
              <group>
                <group name="ticket" string="Ticket">
                  <field name="project_id"/>
                  <field name="task_id" />
                  <field name="date" />
                  <field name="user_id"/>
                  <field name="name" />
                </group>
                <group name="costs" string="Costes">
                  <field name="computed_hours" widget="float_time" string="Horas Computadas"/>
                  <field name="unit_amount" widget="float_time" string="Horas Imputadas"/>
                </group>
              </group>
            </form>
          </field>
          <!-- Recuento de Horas del Ticket-->
          <group class="oe_subtotal_footer oe_right">
            <!-- <field name="total_computed_hours_ticket"  widget="float_time" string="Total Horas Computadas" readonly="1"/> -->
            <field name="total_hours_ticket" widget="float_time" string="Total Horas Imputadas" readonly="1"/>
          </group>
        </page>
      </xpath>
    </field>
  </record>
</data>